use learn16;

select * from emp;

alter TABLE EMP
DROP CONSTRAINT R1;

ALTER TABLE EMP
ADD CONSTRAINT R01 DEFAULT 'MUMBAI' FOR CITY;


CREATE FUNCTION MYSUM (@X AS INT, @Y AS INT)
RETURNS INT 
AS
BEGIN
	DECLARE @Z AS INT;

	SET @Z= @X + @Y;

	RETURN @Z;
END;

SELECT DBO.MYSUM(10,20);

CREATE FUNCTION CAL(@A As INT, @B AS INT , @O AS CHAR(1))
RETURNS INT
AS
BEGIN
	DECLARE @R AS INT;

	IF @O = '+'
		SET @R = @A + @B;
	ELSE IF @O = '-'
		SET @R = @A - @B;
	ELSE IF @O = '/'
		SET @R = @A / @B;
	ELSE IF @O = '*'
		SET @R = @A * @B;
	ELSE IF @O = '%'
		SET @R = @A % @B;
	ELSE
		SET @R = 0;
	RETURN @R;
END;


SELECT DBO.CAL(25,0,'/');


-- RAJEEV GARG E0001 RCG.COM - RGARG0001@RCG.COM

CREATE FUNCTION CMAIL (@N AS VARCHAR(30), @I AS CHAR(5), @D AS VARCHAR(30))
RETURNS vARCHAR(100)
AS
BEGIN
		DECLARE @S AS INT;
		DECLARE @L AS INT;
		DECLARE @EM AS VARCHAR(100);

		SET @S = CHARINDEX(' ', @N);
		SET @L = LEN(@N);

		SET @EM = UPPER(CONCAT(LEFT(@N,1),RIGHT(@N, @L-@S),RIGHT(@I,4),'@', @D));

		RETURN @EM;
END;

SELECT DBO.CMAIL('RAJEEV GARG', 'E0001', 'RCG.COM');

SELECT * FROM EMP;



SELECT EID, NAME, EMAIL, DBO.CMAIL(NAME,EID,'OUTLOOK.COM') AS 'CORP MAIL' FROM EMP;

-- SCALAR FUNCTION / SINGLE VALUED FUNCTION
-- TABLE VALUED FUNCTION


USE TEST;

DROP FUNCTION LB16ESAL	;

CREATE FUNCTION LB16ESAL	()
RETURNS TABLE
AS
	RETURN(SELECT * FROM EMP_SAL
			WHERE DEPT = 'OPS');

SELECT * FROM DBO.LB16ESAL();

CREATE FUNCTION LB16ESAL	(@X AS VARCHAR(30))
RETURNS TABLE
AS
	RETURN(SELECT * FROM EMP_SAL
			WHERE DEPT = @X);


SELECT * FROM DBO.LB16ESAL('ADMIN');

CREATE FUNCTION LB16ESAL(@X AS VARCHAR(30))
RETURNS TABLE
AS
	RETURN(SELECT EMP.EID, NAME, CITY, DOJ, DEPT, DESI, SALARY AS 'BASIC', SALARY *.15 AS 'HRA', SALARY *.09 AS 'PF'
	FROM EMP
	INNER JOIN EMP_SAL
	ON EMP.EID = EMP_SAL.EID
	WHERE DEPT = @X);

SELECT * FROM DBO.LB16ESAL('MIS');

CREATE FUNCTION L16BDAY()
RETURNS TABLE
AS
	RETURN(SELECT EMP.EID, NAME, CITY, DOB, DEPT, DESI, DAY(DOB) AS 'BIRTHDAY'FROM EMP
	INNER JOIN EMP_SAL
	ON EMP.EID =EMP_SAL.EID
	WHERE MONTH(DOB)=MONTH(GETDATE()));

SELECT * FROM DBO.L16BDAY();


SELECT EID FROM EMP_SAL WHERE DESI = 'MANAGER';

SELECT EID, NAME, CITY FROM EMP
WHERE EID IN (1004,1007,1008,1010,1028,1067,1040,1088, 1123);

SELECT * FROM EMP;
SELECT * FROM EMP_SAL;


SELECT EID, NAME, CITY FROM EMP
WHERE EID IN (SELECT EID FROM EMP_SAL WHERE DESI = 'MANAGER');

SELECT  EID, DESI, SALARY FROM EMP_SAL
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'DELHI');

SELECT * FROM TRAINING;

SELECT EMP.EID, NAME, DEPT ,DESI FROM EMP
INNER JOIN EMP_SAL
ON EMP.EID = EMP_SAL.EID
WHERE DEPT = 'MIS';

-- INSERT SUB QUERY

INSERT INTO TRAINING (EID, NAME, DEPT)
(SELECT EMP.EID, NAME, DEPT FROM EMP
INNER JOIN EMP_SAL
ON EMP.EID = EMP_SAL.EID
WHERE DEPT = 'MIS');

SELECT * FROM TRAINING;

UPDATE TRAINING SET MODULE = 'SQL';


-- DELETE SUB QUERY
DELETE FROM TRAINING 
WHERE EID IN ( SELECT EID FROM EMP_SAL WHERE DESI = 'MANAGER');

SELECT * FROM EMP_SAL
WHERE EID IN (SELECT EID FROM EMP WHERE CITY ='DELHI');

-- UPDATE SUB QUERY
UPDATE EMP_SAL SET SALARY = SALARY + 10000
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'DELHI');

SELECT * FROM EMP_SAL
WHERE EID IN (SELECT EID FROM EMP WHERE CITY ='DELHI');


SELECT EID, NAME, CITY FROM EMP
WHERE EID IN(SELECT EID FROM EMP_SAL WHERE SALARY > 200000 )
ORDER BY EID DESC;


SELECT EID, NAME, CITY FROM EMP
WHERE EID IN (SELECT EID FROM EMP_SAL WHERE SALARY > 500000 );


SELECT EID, NAME, CITY FROM EMP
WHERE EID IN (SELECT EID FROM EMP_SAL WHERE SALARY BETWEEN 100000 AND  200000 );

SELECT COUNT(*) AS'TEAM SIZE', AVG(SALARY) AS 'AVGSAL' FROM EMP_SAL;

SELECT COUNT(*) AS'DEL TEAM SIZE', AVG(SALARY) AS 'DELAVGSAL' FROM EMP_SAL
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'DELHI');

SELECT COUNT(*) AS'DEL TEAM SIZE > 200K', AVG(SALARY) AS 'DELAVGSAL > 200K' FROM EMP_SAL  --A
WHERE EID IN (SELECT EID FROM EMP WHERE CITY = 'DELHI' -- B
				AND EID IN (SELECT EID FROM EMP_SAL WHERE SALARY > 200000));--C



-- A =>  B  => C  - A => C
	

SELECT * FROM EMP_SAL WHERE DEPT = 'HR'
AND EXISTS (SELECT * FROM EMP_SAL WHERE DEPT = 'HR' AND SALARY > 300000);